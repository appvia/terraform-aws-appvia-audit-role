AWSTemplateFormatVersion: '2010-09-09'

Parameters:
  AppviaRoleARN:
    Type: String
    Description: Fully-qualified ARN of the remote role
    Default: arn:aws:iam::536471746696:root
  ExternalID:
    Type: String
    Description: External ID shared between consumer and Appvia
  ExpiryDate:
    Type: String

Resources:
  Role:
    Type: AWS::IAM::Role
    Properties:
      RoleName: AppviaAuditRole
      Path: /
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS:
                - !Ref AppviaRoleARN
            Action:
              - sts:AssumeRole
            Condition:
              StringEquals:
                "sts:ExternalId": !Ref ExternalID
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/SecurityAudit
        - arn:aws:iam::aws:policy/ReadOnlyAccess
      Policies:
        - PolicyName: PermissionDeadline
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Deny
                Action: '*'
                Resource: '*'
                Condition:
                  DateGreaterThan:
                    "aws:CurrentTime": !Ref ExpiryDate
